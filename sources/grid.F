      program grid
      implicit double precision(a-h,o-z)
c  -----------------------------------------------------------------
c  |         Creates images of the fields generated by pps.F       |
c  |                                                               |
c  |           +++ run via the script "image"                      |
c  -----------------------------------------------------------------
c     *** now assumes one time frame per file ***
c
      parameter (nh=NH,ngp=nh*nh)
      parameter (mh=MH,mgp=mh*mh)

      dimension qq(nh,nh)
      character bqq(mgp)*1
      character infile1*40,infile2*40
      character qqfile*6

      integer lenchr
      external lenchr
c--------------------------------------------------------

      write(*,*) ' Number of files (1 or 2)? '
      read(*,*) nfile

      ixf=0
      iyf=0
      if((nh/mh).gt.1) then
         write(*,*) ' x,y offset (0,0 = left,top)'
         read(*,*) ixoff,iyoff
         ixf=ixoff*mh
         iyf=iyoff*mh
      endif

      if (nfile .eq. 1) then
        write(*,*) ' Choose one of the following to display:'
        write(*,*) ' (1) PV (qq0000.dat),'
        write(*,*) ' (2) another input file: '
        read(*,*) iopt
        infile1='qq0000.dat'
        qqfile='qq.bin'
        if (iopt .eq. 2) then
          write(*,*) ' Enter file name (e.g. pp0000.dat)? '
          read(*,'(a)') infile1
          j1=lenchr(infile1)
        endif
      else
        write(*,*) ' The difference, file_1 - file_2 is plotted.'
        write(*,*) ' File base name of file_1 (e.g. qq0000)? '
        read(*,'(a)') infile1
        write(*,*) ' File base name of file_2? '
        read(*,'(a)') infile2
        j1=lenchr(infile1)
        j2=lenchr(infile2)
      endif

c--------------------------------------------------------
      open(21,file=qqfile,form='unformatted',access='direct',
     .    status='unknown',recl=mgp)
c        recl = ngp/4 for DEC; = ngp otherwise.

      write(*,*) ' Do you want fixed (0) or free (1) scales for qq?'
      read(*,*) isqq
      if (isqq .eq. 0) then
        write(*,*) ' Enter qq_min & qq_max:'
        read(*,*) qqmin,qqmax
      else
        qqtmax=zero
        qqtmin=zero
      endif

c--------------------------------------------------------
c      Process data:
      loop=0


 99   continue

      if (nfile .eq. 1) then
         write(infile1(j1-6:j1-4),'(i3.3)') loop
         write(*,*) ' Reading data from file ',infile1,' ...'
         open(12,file=infile1,status='old',err=999)
         read(12,*,end=999,err=999) t
         do ix=1,nh
            do iy=1,nh
               read(12,*,end=999,err=999) qq(iy,ix)
            enddo
         enddo
         close(12)
      else
         write(infile1(j1-2:j1),'(i3.3)') loop
         write(infile2(j2-2:j2),'(i3.3)') loop
         open(12,file=infile1,status='old',err=999)
         open(13,file=infile2,status='old',err=999)
         read(12,*,end=999,err=999) t
         read(13,*,end=999,err=999) t
         do ix=1,nh
            do iy=1,nh
               read(12,*,end=999,err=999) qq1
               read(13,*,end=999,err=999) qq2
               qq(iy,ix)=qq1-qq2
            enddo
         enddo
      endif

      loop=loop+1

      if (isqq .eq. 0) then
         do ix=1,nh
            do iy=1,nh
               qq(iy,ix)=min(qqmax,max(qqmin,qq(iy,ix)))
            enddo
         enddo
      else
         qqmax=abs(qq(1,1))
         do ix=1,nh
            do iy=1,nh
              qqmax=max(qqmax,abs(qq(iy,ix)))
            enddo
          enddo
          qqtmax=max(qqtmax,qqmax)
          qqmin=-qqmax
        endif
        cfac=224./(qqmax-qqmin)
        do ix=1,mh
          do iy=1,mh
            bqq(mh*(mh-iy)+ix)=
     .            char(15+nint(cfac*(qq(iy+iyf,ix+ixf)-qqmin)))
          enddo
        enddo
        write(21,rec=loop) (bqq(ii),ii=1,mgp)
c
        if (isqq .eq. 0) then
           write(*,'(a,f6.2)') ' t = ',t
        else
           write(*,'(a,f6.2,a,f10.4)') ' t = ',t,'  max|qq| = ',qqmax
        endif
c
        goto 99
c
999   close(21)
c
      write(*,*)
c
      if (isqq .ne. 0) then
        write(*,'(a,f9.4)') ' ===> Over all time, max|qq| = ',qqtmax
        write(*,*)
      endif
c
      write(*,*) ' Data is ready for display.'
      write(*,*)
      write(*,*) ' *** Use the commands'
      write(*,*)
      write(*,1) ' xvidi -dwidth ',mh,' ',qqfile,' &'
      write(*,*)
1     format(a,i4,a,a,a)
      stop
      end

c----------------------------------------------------------------
      integer function lenchr(chrstg)
c     function to find right-most non-blank character in string
      character*(*) chrstg
      integer l
      lenchr=0
      do l=len(chrstg),1,-1
         if (chrstg(l:l).ne.' ' .and. chrstg(l:l).ne.char(0)) then
            lenchr=l
            goto 10
         endif
      enddo
 10   return
      end

